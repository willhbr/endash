defaults:
  build: :all
  run: dev
  update: prod

images:
  dev:
    tag: endash:dev-latest
    from: Containerfile.dev
    build_flags:
      build-context: lemur=../lemur
      build-context: status_page=../status_page
  prod:
    tag: endash:prod-latest
    from: Containerfile.prod
    build_flags:
      build-context: lemur=../lemur
      build-context: status_page=../status_page

labels: &labels
  endash.links:
    - name: Status
      port: 80
      path: /status
    - name: Dash
      port: 80
  endash.labels:
    - It's me!

containers:
  dev:
    name: endash-dev
    image: endash:dev-latest
    interactive: true
    autoremove: true
    ports:
      5050: 80
    labels:
      <<: *labels
    bind_mounts:
      # binding the source directory lets us re-run changes without rebuilding
      src: /src/src
      ../lemur: /shards/lemur
      ../status_page: /shards/status_page
      .cache: /root/.cache/crystal
      # /home/will/.ssh: /root/.ssh,ro
      /run/user/1000/podman/podman.sock: /run/user/podman/podman.sock
    flags:
      host:
        name: Steve
        hostname: steve
        podman_url: "unix:///run/user/podman/podman.sock"

  prod:
    name: endash-prod
    image: endash:prod-latest
    ports:
      5049: 80
    bind_mounts:
      /run/user/1000/podman/podman.sock: /run/user/podman/podman.sock
    labels:
      <<: *labels
    flags:
      host:
        name: Steve
        hostname: steve
        podman_url: "unix:///run/user/podman/podman.sock"
